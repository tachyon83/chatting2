<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>chat_index.html</title>
    <style>
        .room {
            border: 1px solid dodgerblue;
        }

        ::selection {
            border: 2px solid orange
        }

        div#chatLog {
            width: 400px;
            height: 200px;
        }

        div#chatpad {
            display: none;
        }
    </style>
    <script>
        // window.onload = function () {
        //     var socket = io();
        //     // const urlParams = new URLSearchParams(window.location.search);
        //     // const mypID = urlParams.get('pID');
    </script>
</head>

<body>
    <div id="roomList"></div>
    <div id='chatLog'></div>
    <div id='chatPad'>
        <textarea id='chatText'></textarea>
        <button id='chatBtn'>send</button>
        <button id='roomLeave'>leave</button>
    </div>
    <script src='/socket.io/socket.io.js'></script>
    <script>
        var socket = io();
        var profileDTO = null;
        var userId = null;
        var rooms = null;
        // var roomDTO;
        var chatLogDiv = document.getElementById('chatLog');
        var roomListDiv = document.getElementById('roomList');
        var chatPadDiv = document.getElementById('chatPad');
        var chatText = document.getElementById('chatText');
        var chatBtn = document.getElementById('chatBtn');
        var roomLeave = document.getElementById('roomLeave');

        chatBtn.addEventListener('click', () => {
            var chatDTO = {
                from: userId,
                to: null,
                text: chatText.value,
            }
            chatText.value = ''
            socket.emit('chat.public', chatDTO);
        })
        roomLeave.addEventListener('click', () => {
            // socket.emit('room.leave');

        })

        function roomListRefreshServerCall(callback) {
            socket.emit('room.list');
            socket.on('room.list.response', roomsFromServer => {
                rooms = roomsFromServer
                callback(rooms);
            })
        }

        setInterval(() => { roomListRefreshServerCall(roomListRefresher) }, 500);

        function roomListRefresher(rooms) {
            for (var key of Object.keys(rooms)) {
                var temp = document.getElementById(key);
                if (temp != null) temp.innerText = JSON.stringify(rooms[key]);
                else {
                    let newRoom = document.createElement('p');
                    newRoom.className = 'room';
                    newRoom.id = key

                    newRoom.addEventListener("dblclick", () => {
                        const roomDTO = rooms[newRoom.id];
                        socket.emit('room.join', roomDTO);
                    })
                    newRoom.innerText = JSON.stringify(rooms[key]);
                    roomListDiv.appendChild(newRoom);
                }
            }
        }

        socket.on('room.join.response', ok => {
            if (ok) {
                chatLogDiv.style.backgroundColor = "aliceblue";
                roomListDiv.style.display = "none";
                chatPadDiv.style.display = "visible";
            }
        })
        // socket.on('system.invite', profileDTO => {
        socket.on('system.invite', id => {
            console.log('system invited')
            // userId = profileDTO.id
            userId = id
            var temp = document.createElement('p');
            temp.innerText = id + ' joined';
            chatLogDiv.appendChild(temp);
        })
        socket.on('chat.public', chatDTO => {
            var temp = document.createElement('p');
            temp.innerText = chatDTO.from + ': ' + chatDTO.text;
            chatLogDiv.appendChild(temp);
        })
    </script>
</body>

</html>